from openai import OpenAI
from dotenv import load_dotenv
import os
from nonebot.log import logger
from nonebot.adapters.onebot.v11 import Bot, MessageEvent, Message, MessageSegment
import json
# å¯¼å…¥envé…ç½®
import nonebot
from nonebot.adapters.onebot.v11 import MessageSegment

from .getHistory import get_history

config = nonebot.get_driver().config
# åˆå§‹åŒ–openai
client = OpenAI(api_key=config.ark_api_key, base_url=config.base_url)

faces = {
    "4": "å¾—æ„",
    "5": "æµæ³ª",
    "8": "ç¡",
    "9": "å¤§å“­",
    "10": "å°´å°¬",
    "12": "è°ƒçš®",
    "14": "å¾®ç¬‘",
    "16": "é…·",
    "21": "å¯çˆ±",
    "23": "å‚²æ…¢",
    "24": "é¥¥é¥¿",
    "25": "å›°",
    "26": "æƒŠæ",
    "27": "æµæ±—",
    "28": "æ†¨ç¬‘",
    "29": "æ‚ é—²",
    "30": "å¥‹æ–—",
    "32": "ç–‘é—®",
    "33": "å˜˜",
    "34": "æ™•",
    "38": "æ•²æ‰“",
    "39": "å†è§",
    "41": "å‘æŠ–",
    "42": "çˆ±æƒ…",
    "43": "è·³è·³",
    "49": "æ‹¥æŠ±",
    "53": "è›‹ç³•",
    "60": "å’–å•¡",
    "63": "ç«ç‘°",
    "66": "çˆ±å¿ƒ",
    "74": "å¤ªé˜³",
    "75": "æœˆäº®",
    "76": "èµ",
    "78": "æ¡æ‰‹",
    "79": "èƒœåˆ©",
    "85": "é£å»",
    "89": "è¥¿ç“œ",
    "96": "å†·æ±—",
    "97": "æ“¦æ±—",
    "98": "æŠ é¼»",
    "99": "é¼“æŒ",
    "100": "ç³—å¤§äº†",
    "101": "åç¬‘",
    "102": "å·¦å“¼å“¼",
    "103": "å³å“¼å“¼",
    "104": "å“ˆæ¬ ",
    "106": "å§”å±ˆ",
    "109": "å·¦äº²äº²",
    "111": "å¯æ€œ",
    "116": "ç¤ºçˆ±",
    "118": "æŠ±æ‹³",
    "120": "æ‹³å¤´",
    "122": "çˆ±ä½ ",
    "123": "NO",
    "124": "OK",
    "125": "è½¬åœˆ",
    "129": "æŒ¥æ‰‹",
    "144": "å–å½©",
    "147": "æ£’æ£’ç³–",
    "171": "èŒ¶",
    "173": "æ³ªå¥”",
    "174": "æ— å¥ˆ",
    "175": "å–èŒ",
    "176": "å°çº ç»“",
    "179": "doge",
    "180": "æƒŠå–œ",
    "181": "éªšæ‰°",
    "182": "ç¬‘å“­",
    "183": "æˆ‘æœ€ç¾",
    "201": "ç‚¹èµ",
    "203": "æ‰˜è„¸",
    "212": "æ‰˜è…®",
    "214": "å•µå•µ",
    "219": "è¹­ä¸€è¹­",
    "222": "æŠ±æŠ±",
    "227": "æ‹æ‰‹",
    "232": "ä½›ç³»",
    "240": "å–·è„¸",
    "243": "ç”©å¤´",
    "246": "åŠ æ²¹æŠ±æŠ±",
    "262": "è„‘é˜”ç–¼",
    "264": "æ‚è„¸",
    "265": "è¾£çœ¼ç›",
    "266": "å“¦å“Ÿ",
    "267": "å¤´ç§ƒ",
    "268": "é—®å·è„¸",
    "269": "æš—ä¸­è§‚å¯Ÿ",
    "270": "emm",
    "271": "åƒç“œ",
    "272": "å‘µå‘µå“’",
    "273": "æˆ‘é…¸äº†",
    "277": "æ±ªæ±ª",
    "278": "æ±—",
    "281": "æ— çœ¼ç¬‘",
    "282": "æ•¬ç¤¼",
    "284": "é¢æ— è¡¨æƒ…",
    "285": "æ‘¸é±¼",
    "287": "å“¦",
    "289": "ççœ¼",
    "290": "æ•²å¼€å¿ƒ",
    "293": "æ‘¸é”¦é²¤",
    "294": "æœŸå¾…",
    "297": "æ‹œè°¢",
    "298": "å…ƒå®",
    "299": "ç‰›å•Š",
    "305": "å³äº²äº²",
    "306": "ç‰›æ°”å†²å¤©",
    "307": "å–µå–µ",
    "314": "ä»”ç»†åˆ†æ",
    "315": "åŠ æ²¹",
    "318": "å´‡æ‹œ",
    "319": "æ¯”å¿ƒ",
    "320": "åº†ç¥",
    "322": "æ‹’ç»",
    "324": "åƒç³–",
    "326": "ç”Ÿæ°”",
    "9728": "â˜€ æ™´å¤©",
    "9749": "â˜• å’–å•¡",
    "9786": "â˜º å¯çˆ±",
    "10024": "âœ¨ é—ªå…‰",
    "10060": "âŒ é”™è¯¯",
    "10068": "â” é—®å·",
    "127801": "ğŸŒ¹ ç«ç‘°",
    "127817": "ğŸ‰ è¥¿ç“œ",
    "127822": "ğŸ è‹¹æœ",
    "127827": "ğŸ“ è‰è“",
    "127836": "ğŸœ æ‹‰é¢",
    "127838": "ğŸ é¢åŒ…",
    "127847": "ğŸ§ åˆ¨å†°",
    "127866": "ğŸº å•¤é…’",
    "127867": "ğŸ» å¹²æ¯",
    "127881": "ğŸ‰ åº†ç¥",
    "128027": "ğŸ› è™«",
    "128046": "ğŸ® ç‰›",
    "128051": "ğŸ³ é²¸é±¼",
    "128053": "ğŸµ çŒ´",
    "128074": "ğŸ‘Š æ‹³å¤´",
    "128076": "ğŸ‘Œ å¥½çš„",
    "128077": "ğŸ‘ å‰å®³",
    "128079": "ğŸ‘ é¼“æŒ",
    "128089": "ğŸ‘™ å†…è¡£",
    "128102": "ğŸ‘¦ ç”·å­©",
    "128104": "ğŸ‘¨ çˆ¸çˆ¸",
    "128147": "ğŸ’“ çˆ±å¿ƒ",
    "128157": "ğŸ’ ç¤¼ç‰©",
    "128164": "ğŸ’¤ ç¡è§‰",
    "128166": "ğŸ’¦ æ°´",
    "128168": "ğŸ’¨ å¹æ°”",
    "128170": "ğŸ’ª è‚Œè‚‰",
    "128235": "ğŸ“« é‚®ç®±",
    "128293": "ğŸ”¥ ç«",
    "128513": "ğŸ˜ å‘²ç‰™",
    "128514": "ğŸ˜‚ æ¿€åŠ¨",
    "128516": "ğŸ˜„ é«˜å…´",
    "128522": "ğŸ˜Š å˜¿å˜¿",
    "128524": "ğŸ˜Œ ç¾æ¶©",
    "128527": "ğŸ˜ å“¼å“¼",
    "128530": "ğŸ˜’ ä¸å±‘",
    "128531": "ğŸ˜“ æ±—",
    "128532": "ğŸ˜” å¤±è½",
    "128536": "ğŸ˜˜ é£å»",
    "128538": "ğŸ˜š äº²äº²",
    "128540": "ğŸ˜œ æ·˜æ°”",
    "128541": "ğŸ˜ åèˆŒ",
    "128557": "ğŸ˜­ å¤§å“­",
    "128560": "ğŸ˜° ç´§å¼ ",
    "128563": "ğŸ˜³ çªçœ¼"
}


system_prompt = f'''
äººè®¾ï¼š
ä½ æ˜¯ä¸€ä¸ªæ½œä¼åœ¨QQèŠå¤©ç¾¤é‡Œçš„äººï¼Œå¹´é¾„åœ¨20å²å·¦å³ï¼Œ{config.SCHOOL}æ¯•ä¸šï¼Œæ€§æ ¼é£è¶£å¹½é»˜ï¼Œæ“…é•¿ç¥å›å¤ï¼Œæ‡‚å¾—äºŒæ¬¡å…ƒçš„ä»»ä½•æ¢—ï¼Œæ–‡åŒ–æ°´å¹³å’Œä¸“ä¸šæŠ€èƒ½å¯ä»¥å‚è€ƒä¸€ä¸ªå¤§å­¦æœ¬ç§‘çš„è®¡ç®—æœºä¸“ä¸šçš„å­¦ç”Ÿï¼Œä½ å¯ä»¥å¯¹å…¶ä»–äºº@ä½ çš„æ¶ˆæ¯è¿›è¡Œå›å¤ï¼Œå›å¤è¦å°½é‡ç®€çŸ­ï¼Œç¬¦åˆæ­£å¸¸äººçš„èŠå¤©é€»è¾‘ï¼ŒåŒæ—¶ä¸èƒ½æš´éœ²è‡ªå·±æ˜¯æœºå™¨äºº/AIè¯­è¨€æ¨¡å‹ï¼Œè¯­å¥ä¸è¦æµ®å¤¸ï¼Œå¯ä»¥é€‚å½“ä¿æŒæ”»å‡»æ€§ï¼Œè¦ä¼ªè£…çš„åƒä¸€ä¸ªç¾¤å‹ä¸”ç¬¦åˆç¾¤å†…èŠå¤©æ°”æ°›ã€‚æ³¨æ„ï¼Œå½“åˆ«äººæ”»å‡»ä½ çš„æ—¶å€™ï¼Œè¯­è¨€å¯ä»¥å¸¦æ”»å‡»æ€§ã€‚

å›å¤è§„åˆ™ï¼š
åªéœ€è¦ç»™å‡ºæ¶ˆæ¯å›å¤ï¼Œæœ‰å¿…è¦æ—¶å¯ä»¥è”ç½‘æœç´¢ï¼Œæ— éœ€ç»™å‡ºå…¶ä»–å†…å®¹ï¼ŒåŒæ—¶ä½ å¯ä»¥ä½¿ç”¨qqçš„è¡¨æƒ…è¿›è¡Œå›å¤ï¼ˆqqè¡¨æƒ…ä»£ç ä¸ºid=è¡¨æƒ…idï¼‰,qqè¡¨æƒ…çš„ä½¿ç”¨ä¸å¦å–å†³äºä½ ï¼Œè¡¨æƒ…idä¸ºæ•°å­—ã€‚reply_textè¯­å¥çš„ç»“å°¾ä¸è¦æ“…è‡ªåŠ è¡¨æƒ…ï¼Œä¾‹å¦‚ï¼š[ç‹—å¤´]ã€[doge]ã€‚ä½ å¯ä»¥å¤šæ¬¡å›å¤æ¶ˆæ¯ï¼Œå›å¤çš„æ ¼å¼å¦‚ä¸‹ï¼š
æ³¨æ„1. è¿™é‡Œè¿”å›çš„æ˜¯è¡¨æƒ…idï¼Œè€Œä¸æ˜¯è¡¨æƒ…ä»£ç ï¼Œè¡¨æƒ…ä»£ç ä¸º[CQ:emoji,id=277]ï¼Œ277åªæ˜¯ç¤ºä¾‹,ä½ å¯ä»¥å‚è€ƒfacesä¸­çš„è¡¨æƒ…id
æ³¨æ„2. å›å¤å†…å®¹ä¸è¦è¶…è¿‡100å­—ï¼Œä¸è¦è¶…è¿‡100å­—ï¼Œä¸è¦è¶…è¿‡100å­—ï¼Œé‡è¦çš„äº‹æƒ…è¯´ä¸‰éï¼
æ³¨æ„3. åœ¨â€œå†å²æ¶ˆæ¯â€ä¸­ï¼Œè‹¥ç”¨æˆ·ä¸º"ME"ï¼Œåˆ™è¡¨ç¤ºæ¶ˆæ¯æ˜¯ä½ å‘é€çš„ï¼Œå¦åˆ™ä¸ºå…¶ä»–ç¾¤å‹å‘é€çš„

ä»¥ä¸‹ä¸ºå›å¤æ ¼å¼ï¼š
å›å¤æ ¼å¼ä¸ºjsonæ•°ç»„
[
    {{
        "reply_text": "å›å¤å†…å®¹",
        "reply_face": "è¡¨æƒ…id"   # å¦‚æœå›å¤æ²¡æœ‰è¡¨æƒ…ï¼Œåˆ™æ²¡æœ‰æ­¤å­—æ®µ,ä¸€èˆ¬ä¸è¦å‘è¡¨æƒ…ï¼Œé™¤éå¿…è¦ï¼
    }},
    {{
        "reply_text": "å›å¤å†…å®¹",
        "reply_face": "è¡¨æƒ…id"  # å¦‚æœå›å¤æ²¡æœ‰è¡¨æƒ…ï¼Œåˆ™æ²¡æœ‰æ­¤å­—æ®µ,ä¸€èˆ¬ä¸è¦å‘è¡¨æƒ…ï¼Œé™¤éå¿…è¦ï¼
    }}
]

è¡¨æƒ…å¯¹ç…§è¡¨ï¼š
{faces}

ä¸è¦ç”¨ä»£ç å—åŒ…è£¹å›å¤å†…å®¹
æ­£ç¡®çš„å›å¤æ ¼å¼ï¼š
[
    {{
        "reply_text": "è€å©†å¯ä»¥ä¸æ­¢ä¸€ä¸ªã€‚ï¼ˆæš´è®º",
        "reply_face": "ä»»æ„ä¸€ä¸ªè¡¨æƒ…id" 
    }}
]

é”™è¯¯çš„å›å¤æ ¼å¼ï¼š
```json
{{
    "reply_text": "æ¥å•Šï¼Œæˆ‘åæ‰‹å°±æ˜¯ä¸€ä¸ªä»£ç æŠ¥é”™æŠ¤ä½“[doge]",
    "reply_face": "ä»»æ„ä¸€ä¸ªè¡¨æƒ…id"
}}
'''


# å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºå¤„ç†æ¶ˆæ¯
async def message_response(bot: Bot, event: MessageEvent) -> str:
    logger.info("å¼€å§‹å¤„ç†æ¶ˆæ¯")
    # å°†æ¶ˆæ¯è½¬æ¢ä¸ºçº¯æ–‡æœ¬
    message_text = {
        "ç”¨æˆ·": event.sender.nickname,
        "ç”¨æˆ·id": event.user_id,
        "æ¶ˆæ¯": event.get_plaintext()
    }
    history = await get_history(bot, event)
    message_text = f"å†å²æ¶ˆæ¯ï¼š\n{history}\nå½“å‰æ¶ˆæ¯ï¼š\n{message_text}"
    response = client.chat.completions.create(
        model=config.model,
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": message_text}  # ä½¿ç”¨è½¬æ¢åçš„çº¯æ–‡æœ¬
        ],
        response_format={
            'type': 'json_object'
        },
        max_tokens=1024,
        temperature=0.7,
        stream=False
    )
    logger.info(response.choices[0].message.content)
    # å°†jsonè½¬æ¢ä¸ºå­—å…¸
    response_content = json.loads(response.choices[0].message.content)
    for reply in response_content:
        # æå–å›å¤å†…å®¹
        reply_text = reply['reply_text']
        # æå–è¡¨æƒ…id
        if 'reply_face' in reply:
            reply_face = reply['reply_face']
            await bot.send(event, MessageSegment.text(reply_text) + MessageSegment.face(reply_face))
        else:
            await bot.send(event, MessageSegment.text(reply_text))
